# About
This lambda function sends a notification to the user informing them the submission was successful. It reads the submission record from the Results table, calculates the processing time, and then writes a record to the Results table with the processing time, submissionId, and sheet music url.

# Approach
Since Apple limits how long and often code can run while the app is in the background, the app cannot reliably poll the step function for the job status and download url. Instead, I configured the step function talk to Apple's APN (Push Notification Service) to deliver a notification to wake up the app once the job is finished. 

The app shows a popUp that prompts the user to either (1) download the URL or (2) cancel, once the download is received. The listener function is in `AppDelegate` and invokes the showPopup function defined in the `ViewController`.

# TODO
- [] The app should show a popup indicating the job has been submitted. Currently, the button is grayed out and the user does not know if the job is submitted.
- [] Write unit tests
- [] Create a production development profile
- [] Make repo private because it contains some hardcoded secrets.

The app does not use the didReceive handler to process the notification, but somehow is woken up when receiving the notification while in the background. More debug logs are required to find out how the app is woken up.

# Takeaways
### 6. **Do I Need to Enable Background Modes for Push Notifications in iOS?**
   - **Question:** *Do I need to enable "Background Modes" for my app to receive push notifications?*
   - **Answer:** 
     - **Yes**, you must enable the **"Background Modes"** capability in your Xcode project to allow your app to handle push notifications while in the background.
     - Under **Capabilities**, check the **"Background Fetch"** and **"Remote notifications"** options to ensure the app can receive and process notifications while running in the background.
- Version of iOS in App on XCode needs to be equal or less than the iOS version on the target device
- Edit the scheme under the dropdown to enable "Debug" or "Release" mode
- Create a Certificate on Apple Developer and select it on XCode to auto generate a `YouTubeToPDF.entitlements` file. 
- Download the certificate, key. The AWS step function uses the key to generate a temporary JWT token to authenticate with the APN service. The key is stored in S3.


# Development
## cd into the node folder
cd node-lambda

## Initialize a Node.js Project (one-time)
npm init -y

## install dependencies
npm install apn aws-sdk

## prepare the zip deployment package
zip -r function.zip index.mjs node_modules/ package.json

## Upload to AWS Lambda
Go to the AWS Lambda console.
Create a new Lambda function (or update an existing one).
In the "Function code" section, choose the "Upload a .zip file" option.
Click on Upload and select the function.zip file you just created.

# Folder Structure
```
node-lambda/             # folder containing the lambda handler and dependencies
│
├── index.mjs
├── node_modules/        # (installed dependencies, like apn, aws-sdk, etc.)
├── package.json         # (generated by npm init)
```

# Testing
Create a test event with the payload:

```
{
  "jobId": "6a7ba1a7-9484-4208-993a-42f56705d026",
  "input": {
    "statusCode": 200,
    "body": "{\"message\":\"PDF generated successfully and uploaded\", \"presigned_url\": \"https://www.adobe.com/content/dam/cc/en/legal/terms/enterprise/pdfs/GeneralTerms-NA-2024v1.pdf\", \"deviceToken\": \"abc123\"}"
  }
}
```

Invoke the Lambda and confirm the response is:

```json
{
  "statusCode": 200,
  "body": "{\"message\":\"Push notification sent successfully.\"}"
}
```


## Step function definition

The `jobId` parameter is generated dynamically when the Step function is invoked; it is not passed through the lambdas in the step function. The send notification lambda needs this value and gets it from the Step Function native environment.


```json
"Payload": {
  "jobId.$": "$$.Execution.Name",
  "input.$": "$"
}
```

This retrieves the Step Function execution name dynamically from the execution context. We moved jobId into the Payload for downstream Lambda steps, since Step Functions only supports custom inputs inside Payload when invoking Lambdas using arn:aws:states:::lambda:invoke.

Defining this way also result in the original input becoming nested inside of a root-level field called "input". The send-notification lambda has to parse this extra layer to extract the payload.

Logs should contain the following entry that indicates a successful delivery
```
2025-01-26T22:11:59.945Z	1dc5ddb0-2822-4fff-a86d-12eb91f62467	INFO	Notification sent successfully. Response:  {"sent":[{"device":"4c6b80b1c2a6a241cea9b4a1096cb429d2635dca38e8bc0889dd57e9252280d2"}],"failed":[]}
```

Instantly, the push notification should appear on the physical iPhone.

# FAQs
What is the APN device token?
The APNs device [token](https://developer.apple.com/documentation/bundleresources/entitlements/aps-environment) is typically a 64-byte hexadecimal string, but the length and format might vary depending on the environment (sandbox vs production).

Is the UUID listed under "Devices" in my Apple developer account a device token?
No. It is generated when you plug your device into your computer and inspect the Xcode logs in debug mode. It is generated from this line:

`let tokenString = deviceToken.map { String(format: "%02x", $0) }.joined()`

Does it need to be encoded before calling the `apn` library?
No

Can the device receive the notification when unplugged?
Yes

Can the device receive the notification using the development certificate?
Yes

What is causing this BadDeviceToken response from APNs?
The value you supplied was the device UUID (from the Apple Developer Portal) not the APN device token gotten from the console logs. 

You must also ensure the correct [environment](https://forums.developer.apple.com/forums/thread/689857) for the APN service you are calling with your "development" token.