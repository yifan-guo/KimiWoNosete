# Development
## cd into the node folder
cd node-lambda

## Initialize a Node.js Project (one-time)
npm init -y

## install dependencies
npm install apn aws-sdk

## prepare the zip deployment package
zip -r function.zip index.mjs node_modules/ package.json

## Upload to AWS Lambda
Go to the AWS Lambda console.
Create a new Lambda function (or update an existing one).
In the "Function code" section, choose the "Upload a .zip file" option.
Click on Upload and select the function.zip file you just created.

# Folder Structure
```
node-lambda/             # folder containing the lambda handler and dependencies
│
├── index.mjs
├── node_modules/        # (installed dependencies, like apn, aws-sdk, etc.)
├── package.json         # (generated by npm init)
```

# Testing
Create a test event with the payload:
```
{
  "presigned_url": "https://www.adobe.com/content/dam/cc/en/legal/terms/enterprise/pdfs/GeneralTerms-NA-2024v1.pdf"
}
```

Invoke the Lambda and confirm the response is:
```
{
  "statusCode": 200,
  "body": "{\"message\":\"Push notification sent successfully.\"}"
}
```

Logs should contain the following entry that indicates a successful delivery
```
2025-01-26T22:11:59.945Z	1dc5ddb0-2822-4fff-a86d-12eb91f62467	INFO	Notification sent successfully. Response:  {"sent":[{"device":"4c6b80b1c2a6a241cea9b4a1096cb429d2635dca38e8bc0889dd57e9252280d2"}],"failed":[]}
```

Instantly, the push notification should appear on the physical iPhone.

# FAQs
What is the APN device token?
The APNs device [token](https://developer.apple.com/documentation/bundleresources/entitlements/aps-environment) is typically a 64-byte hexadecimal string, but the length and format might vary depending on the environment (sandbox vs production).

Is the UUID listed under "Devices" in my Apple developer account a device token?
No. It is generated when you plug your device into your computer and inspect the Xcode logs in debug mode. It is generated from this line:

`let tokenString = deviceToken.map { String(format: "%02x", $0) }.joined()`

Does it need to be encoded before calling the `apn` library?
No

Can the device receive the notification when unplugged?
Yes

Can the device receive the notification using the development certificate?
Yes

What is causing this BadDeviceToken response from APNs?
The value you supplied was the device UUID (from the Apple Developer Portal) not the APN device token gotten from the console logs. 

You must also ensure the correct [environment](https://forums.developer.apple.com/forums/thread/689857) for the APN service you are calling with your "development" token.